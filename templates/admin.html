{% extends "base.html" %}

{% block title %}Wallets{% endblock %}

{% block extra_head %}
<style>
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #8b92b0;
        font-size: 0.9rem;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 10px;
        background: #1a1f3a;
        border: 1px solid #252b4a;
        border-radius: 4px;
        color: #fff;
        font-size: 0.9rem;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #00d4ff;
        box-shadow: 0 0 5px rgba(0, 212, 255, 0.3);
    }
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    .btn-danger {
        background: #ff4757;
        color: #fff;
    }
    .btn-danger:hover {
        background: #ff3742;
    }
    .btn-info {
        background: #17a2b8;
        color: #fff;
    }
    .btn-info:hover {
        background: #138496;
    }
    .badge-not-tested { background: #66666644; color: #999; }
    .badge-connected { background: #00ff8844; color: #00ff88; }
    .badge-error { background: #ff475744; color: #ff4757; }
    .instructions {
        background: #1a1f3a;
        padding: 15px;
        border-radius: 4px;
        border-left: 4px solid #00d4ff;
        margin-bottom: 15px;
    }
    .instructions h4 {
        color: #00d4ff;
        margin-bottom: 10px;
    }
    .instructions ol {
        margin-left: 20px;
    }
    .instructions li {
        margin-bottom: 5px;
        color: #8b92b0;
    }
    .hidden { display: none; }
    .provider-field {
        margin-bottom: 15px;
    }
    .test-result {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    .test-success {
        background: #00ff8844;
        color: #00ff88;
        border: 1px solid #00ff88;
    }
    .test-error {
        background: #ff475744;
        color: #ff4757;
        border: 1px solid #ff4757;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="/">ðŸ“Š Overview</a>
    <span class="separator">â€º</span>
    <span class="current">ðŸ’¼ Wallets</span>
</div>
{% endblock %}

{% block content %}

<h1>Wallets</h1>

<!-- Admin Tools / Quick Links -->
<div class="section" style="display: flex; align-items: center; justify-content: space-between;">
    <h2 style="margin: 0;">Admin Tools</h2>
    <div style="display: flex; gap: 10px;">
        <a href="/admin/strategies" class="btn btn-primary">Manage Strategies</a>
        <a href="/admin/exchange-logs" class="btn btn-primary">View Exchange Logs</a>
    </div>
</div>

        <!-- Existing Wallets Section (Moved to Top) -->
        <div class="section">
            <h2>Configured Wallets</h2>
            {% if wallets %}
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Provider</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Last Known Value</th>
                            <th>Last Test</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for wallet in wallets %}
                        <tr>
                            <td>{{ wallet.name }}</td>
                            <td>{{ wallet.provider.replace('_', ' ').title() }}</td>
                            <td>{{ wallet.wallet_type.title() }}</td>
                            <td>
                                <span class="badge badge-{{ wallet.status }}">
                                    {{ wallet.status.replace('_', ' ').title() }}
                                </span>
                            </td>
                            <td>
                                {% if wallet.equity %}
                                    <span style="color: #00d4ff; font-weight: 600;">
                                        ${{ "{:,.2f}".format(wallet.equity) }}
                                    </span>
                                {% else %}
                                    <span style="color: #8b92b0; font-style: italic;">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if wallet.last_test %}
                                    {{ wallet.last_test.strftime('%Y-%m-%d %H:%M') }}
                                {% else %}
                                    Never
                                {% endif %}
                            </td>
                            <td>{{ wallet.created_at.strftime('%Y-%m-%d') }}</td>
                            <td>
                                {% if wallet.status == 'connected' %}
                                <a href="/wallet/{{ wallet.id }}" class="btn btn-primary" style="
                                    display: inline-block;
                                    padding: 6px 12px;
                                    background: #00d4ff;
                                    color: #0a0e27;
                                    text-decoration: none;
                                    border-radius: 4px;
                                    font-weight: 600;
                                    font-size: 0.85rem;
                                    margin-right: 5px;
                                ">ðŸ“Š Dashboard</a>
                                {% endif %}
                                <a href="{{ url_for('edit_wallet', wallet_id=wallet.id) }}" class="btn btn-info btn-sm" style="margin-right: 5px;">
                                    Edit
                                </a>
                                <button class="btn btn-secondary btn-sm" onclick="testConnection({{ wallet.id }})" style="margin-right: 5px;">
                                    Test
                                </button>
                                <form method="POST" action="{{ url_for('delete_wallet', wallet_id=wallet.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this wallet?')">
                                    {% if config.WTF_CSRF_ENABLED %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>{% endif %}
                                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p style="color: #8b92b0; font-style: italic;">No wallets configured yet. Add your first wallet below.</p>
            {% endif %}
        </div>

        <!-- Add Wallet Section -->
        <div class="section">
            <h2>Add New Wallet</h2>
            <form method="POST" action="{{ url_for('add_wallet') }}" id="walletForm">
                {% if config.WTF_CSRF_ENABLED %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>{% endif %}
                <div class="form-row">
                    <div class="form-group">
                        <label for="name">Wallet Name</label>
                        <input type="text" id="name" name="name" required placeholder="My Trading Wallet">
                    </div>
                    <div class="form-group">
                        <label for="provider">Provider</label>
                        <select id="provider" name="provider" required onchange="updateFormFields()">
                            <option value="">Select Provider</option>
                            <option value="apex_omni">Apex Omni</option>
                            <option value="hyperliquid">Hyperliquid</option>
                            <option value="property">Property/Fixed Assets</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="api_name">API Name (optional)</label>
                    <input type="text" id="api_name" name="api_name" placeholder="e.g., Read-Only Key #1">
                </div>

                <div class="form-group">
                    <label for="wallet_type">Wallet Type</label>
                    <select id="wallet_type" name="wallet_type" required>
                        <option value="crypto">Cryptocurrency</option>
                        <option value="stocks">Stocks</option>
                        <option value="property">Property/Fixed Assets</option>
                    </select>
                </div>
                
                <!-- Provider-specific fields -->
                <div id="provider-fields">
                    <!-- Fields will be populated by JavaScript -->
                </div>
                
                <!-- Provider instructions -->
                <div id="provider-instructions" class="instructions hidden">
                    <!-- Instructions will be populated by JavaScript -->
                </div>
                
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Add Wallet</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Provider field configurations
        const providerConfigs = {
            'apex_omni': {
                fields: [
                    { name: 'api_key', label: 'API Key', type: 'text', required: true, help: 'Your Apex Omni API key' },
                    { name: 'api_secret', label: 'API Secret', type: 'password', required: true, help: 'Your Apex Omni API secret' },
                    { name: 'api_passphrase', label: 'API Passphrase', type: 'password', required: true, help: 'Your Apex Omni API passphrase' }
                ],
                instructions: [
                    '1. Log into your Apex Omni account',
                    '2. Go to API Management section',
                    '3. Create a new API key with read permissions',
                    '4. Copy your API Key, Secret, and Passphrase'
                ]
            },
            'hyperliquid': {
                fields: [
                    { name: 'wallet_address', label: 'Wallet Address', type: 'text', required: true, help: 'Your Ethereum wallet address (starts with 0x)' }
                ],
                instructions: [
                    '1. Go to https://app.hyperliquid.xyz',
                    '2. Connect your wallet',
                    '3. Copy your wallet address from the top-right corner',
                    '4. Paste the wallet address below (starts with 0x)',
                    '5. No API keys needed - Hyperliquid uses wallet addresses for read access'
                ]
            },
            'property': {
                fields: [
                    { name: 'asset_name', label: 'Asset Name', type: 'text', required: true, help: 'Name or description of the asset (e.g., "123 Main St, Apartment")' },
                    { name: 'asset_value', label: 'Current Value', type: 'number', required: true, help: 'Current estimated value of the asset' },
                    { name: 'asset_currency', label: 'Currency', type: 'text', required: true, value: 'USD', help: 'Currency code (USD, EUR, etc.)' }
                ],
                instructions: [
                    '1. Enter a descriptive name for your asset',
                    '2. Set the current estimated value',
                    '3. Choose the currency (USD, EUR, etc.)',
                    '4. This will be used for tracking your total net worth'
                ]
            }
        };

        function updateFormFields() {
            const provider = document.getElementById('provider').value;
            const fieldsContainer = document.getElementById('provider-fields');
            const instructionsContainer = document.getElementById('provider-instructions');
            
            // Clear existing fields
            fieldsContainer.innerHTML = '';
            instructionsContainer.innerHTML = '';
            
            if (!provider || !providerConfigs[provider]) {
                instructionsContainer.classList.add('hidden');
                return;
            }
            
            const config = providerConfigs[provider];
            
            // Update wallet type based on provider
            const walletTypeSelect = document.getElementById('wallet_type');
            if (provider === 'property') {
                walletTypeSelect.value = 'property';
            } else if (provider === 'apex_omni' || provider === 'hyperliquid') {
                walletTypeSelect.value = 'crypto';
            }
            
            // Add fields
            config.fields.forEach(field => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'provider-field';
                
                const label = document.createElement('label');
                label.setAttribute('for', field.name);
                label.textContent = field.label + (field.required ? ' *' : '');
                fieldDiv.appendChild(label);
                
                if (field.type === 'select') {
                    const select = document.createElement('select');
                    select.setAttribute('name', field.name);
                    select.setAttribute('id', field.name);
                    if (field.required) select.setAttribute('required', 'required');
                    
                    field.options.forEach(([value, text]) => {
                        const option = document.createElement('option');
                        option.setAttribute('value', value);
                        option.textContent = text;
                        select.appendChild(option);
                    });
                    
                    fieldDiv.appendChild(select);
                } else {
                    const input = document.createElement('input');
                    input.setAttribute('type', field.type);
                    input.setAttribute('name', field.name);
                    input.setAttribute('id', field.name);
                    input.setAttribute('placeholder', field.help);
                    if (field.required) input.setAttribute('required', 'required');
                    if (field.value) input.setAttribute('value', field.value);
                    fieldDiv.appendChild(input);
                }
                
                const help = document.createElement('small');
                help.style.color = '#8b92b0';
                help.style.fontSize = '0.8rem';
                help.textContent = field.help;
                fieldDiv.appendChild(help);
                
                fieldsContainer.appendChild(fieldDiv);
            });
            
            // Add instructions
            if (config.instructions.length > 0) {
                const title = document.createElement('h4');
                title.textContent = `${provider.replace('_', ' ').toUpperCase()} Setup Instructions`;
                instructionsContainer.appendChild(title);
                
                const ol = document.createElement('ol');
                config.instructions.forEach(instruction => {
                    const li = document.createElement('li');
                    li.textContent = instruction;
                    ol.appendChild(li);
                });
                instructionsContainer.appendChild(ol);
                
                instructionsContainer.classList.remove('hidden');
            }
        }

        function testConnection(walletId) {
            const button = event.target;
            const originalText = button.textContent;
            
            // Show loading state
            button.textContent = 'Testing...';
            button.disabled = true;
            
            // Make AJAX request
            fetch(`/admin/test_wallet/${walletId}`)
                .then(response => response.json())
                .then(data => {
                    // Show result
                    showTestResult(data.success, data.message);
                    
                    // Update button
                    button.textContent = originalText;
                    button.disabled = false;
                    
                    // Reload page to update status badges
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showTestResult(false, 'Connection test failed');
                    button.textContent = originalText;
                    button.disabled = false;
                });
        }

        function showTestResult(success, message) {
            // Remove existing test results
            const existingResults = document.querySelectorAll('.test-result');
            existingResults.forEach(result => result.remove());
            
            // Create new test result
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${success ? 'test-success' : 'test-error'}`;
            resultDiv.textContent = `${success ? 'âœ“' : 'âœ—'} ${message}`;
            
            // Insert after the form
            const form = document.getElementById('walletForm');
            form.parentNode.insertBefore(resultDiv, form.nextSibling);
            
            // Remove after 5 seconds
            setTimeout(() => {
                resultDiv.remove();
            }, 5000);
        }

        // Initialize form on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateFormFields();
        });
    </script>

{% endblock %}
